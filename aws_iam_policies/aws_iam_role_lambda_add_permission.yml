AnalysisType: policy
Filename: aws_iam_role_lambda_add_permission.py
PolicyID: AWS.IAM.Role.LambdaAddPermission
DisplayName: AWS IAM Role Allows Lambda AddPermission
Enabled: false
ResourceTypes:
  - AWS.IAM.Role
Tags:
  - AWS
  - Identity & Access Management
  - Configuration Required
Severity: Critical
Description: >
  This policy validates that IAM roles that grant the lambda AddPermission permission do not allow accounts outside the organization to assume them. This prevents unauthorized third parties, such as vendors, from granting themselves additional permissions to lambdas in the account.
Tests:
  -
    Name: Lambda AddPermission Internal Account Inline
    ExpectedResult: true
    Resource:
      {
        "AccountId": "123456789012",
        "Arn": "arn:aws:iam::123456789012:role/SampleRole",
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Condition": {},
              "Effect": "Allow",
              "Principal": {
                "AWS": "arn:aws:iam::123456789012:role/CONFIGURATION_REQUIRED_set_AccountId_to_any_org_acct_see_accounts_variable"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "CreateDate": "2018-01-01T19:00:00+00:00",
        "InlinePolicies": {
          "TestLambdaPolicy": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"lambda:AddPermission\", \"test:Permission\"],\"Resource\": \"*\"}]}",
          "TestPolicy2": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"test:Permission\", \"test2:Permission\"],\"Resource\": \"*\"}]}"
        },
        "ManagedPolicyNames": [],
        "Path": "/",
        "RoleId": "ROLEID",
        "RoleName": "SampleRole"
      }
  -
    Name: Lambda AddPermission Internal Account Managed
    ExpectedResult: true
    Resource:
      {
        "AccountId": "123456789012",
        "CONFIGURATION_REQUIRED": "set_AccountId_to_any_org_acct_see_accounts_variable",
        "Arn": "arn:aws:iam::123456789012:role/SampleRole",
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Condition": {},
              "Effect": "Allow",
              "Principal": {
                "AWS": "arn:aws:iam::123456789012:role/CONFIGURATION_REQUIRED_set_AccountId_to_any_org_acct_see_accounts_variable"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "CreateDate": "2018-01-01T19:00:00+00:00",
        "InlinePolicies": {
          "TestPolicy1": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"test:Permission1\", \"test:Permission2\"],\"Resource\": \"*\"}]}",
          "TestPolicy2": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"test:Permission1\", \"test:Permission2\"],\"Resource\": \"*\"}]}"
        },
        "ManagedPolicyNames": [
          "CONFIGURATION_REQUIRED_Policy_must_actually_exist_in_AccountId_and_have_lambda_addpermission",
          "Alternate_method_is_create_mock_see_instructions_in_policy"
        ],
        "Path": "/",
        "RoleId": "ROLEID",
        "RoleName": "SampleRole"
      }
  -
    Name: Lambda AddPermission External Account Inline
    ExpectedResult: false
    Resource:
      {
        "AccountId": "123456789012",
        "Arn": "arn:aws:iam::702605134623:role/SampleRole",
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Condition": {},
              "Effect": "Allow",
              "Principal": {
                "AWS": [
                  "arn:aws:iam::123456789012:role/CONFIGURATION_REQUIRED_set_AccountId_to_any_org_acct_see_accounts_variable",
                  "arn:aws:iam::123456789013:root"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "CreateDate": "2018-01-01T19:00:00+00:00",
        "InlinePolicies": {
          "TestLambdaPolicy": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"lambda:AddPermission\", \"test:Permission\"],\"Resource\": \"*\"}]}",
          "TestPolicy2": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"test:Permission\", \"test2:Permission\"],\"Resource\": \"*\"}]}"
        },
        "ManagedPolicyNames": [],
        "Path": "/",
        "RoleId": "ROLEID",
        "RoleName": "SampleRole"
      }   
  -
    Name: Lambda AddPermission External Account Managed
    ExpectedResult: false
    Resource:
      {
        "AccountId": "123456789012",
        "CONFIGURATION_REQUIRED": "set_AccountId_to_any_org_acct_see_accounts_variable",
        "Arn": "arn:aws:iam::123456789012:role/SampleRole",
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Condition": {},
              "Effect": "Allow",
              "Principal": {
                "AWS": "arn:aws:iam::123456789012:root"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "CreateDate": "2018-01-01T19:00:00+00:00",
        "InlinePolicies": {
          "TestPolicy1": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"test:Permission1\", \"test:Permission1\"],\"Resource\": \"*\"}]}",
          "TestPolicy2": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"test:Permission1\", \"test:Permission2\"],\"Resource\": \"*\"}]}"
        },
        "ManagedPolicyNames": [
          "CONFIGURATION_REQUIRED_Policy_must_actually_exist_in_AccountId_and_have_lambda_addpermission",
          "Alternate_method_is_create_mock_see_instructions_in_policy"
        ],
        "Path": "/",
        "RoleId": "ROLEID",
        "RoleName": "SampleRole"
      }
  -
    Name: No Lambda AddPermission
    ExpectedResult: true
    Resource:
      {
        "AccountId": "123456789012",
        "CONFIGURATION_REQUIRED": "set_AccountId_to_any_org_acct_see_accounts_variable",
        "Arn": "arn:aws:iam::123456789012:role/SampleRole",
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Condition": {},
              "Effect": "Allow",
              "Principal": {
                "AWS": "arn:aws:iam::123456789012:root"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "CreateDate": "2018-01-01T19:00:00+00:00",
        "InlinePolicies": {
          "TestPolicy1": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"test:Permission1\", \"test:Permission2\"],\"Resource\": \"*\"}]}",
          "TestPolicy2": "{\"Version\": \"2012-10-17\",\"Statement\": [{ \"Sid\": \"TestSid\",\"Effect\": \"Allow\",\"Action\": [\"test:Permission1\", \"test:Permission2\"],\"Resource\": \"*\"}]}"
        },
        "ManagedPolicyNames": [
          "CONFIGURATION_REQUIRED_Policy_must_actually_exist_in_AccountId_and_NOT_have_lambda_addpermission",
          "Alternate_method_is_create_mock_see_instructions_in_policy"
        ],
        "Path": "/",
        "RoleId": "ROLEID",
        "RoleName": "SampleRole"
      }
